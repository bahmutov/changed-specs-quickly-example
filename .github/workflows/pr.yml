name: PR checks
on: [pull_request]
jobs:
  find-changed-specs:
    runs-on: ubuntu-22.04
    outputs:
      changedSpecs: ${{ steps.trace.outputs.changedSpecs }}
      changedSpecsN: ${{ steps.trace.outputs.changedSpecsN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # need to fetch info about all branches
          # to determine the changed spec files
          # https://glebbahmutov.com/blog/faster-ci-feedback/
          fetch-depth: 0

      - name: Install find-cypress-specs ðŸ“¦
        # https://github.com/bahmutov/npm-install
        uses: bahmutov/npm-install@v1
        with:
          # use just package.json checksum
          useLockFile: false
          install-command: 'npm install find-cypress-specs'
          cache-key-prefix: 'find-cypress-specs'

      - name: Trace changed specs
        # against the "main" branch
        # and including changed files imported by specs
        # https://github.com/bahmutov/find-cypress-specs
        id: trace
        run: npm run trace-changed-specs -- --set-gha-outputs --gha-summary

  # run all changed specs on a single machine
  changed-specs:
    needs: find-changed-specs
    if: ${{ needs.find-changed-specs.outputs.changedSpecsN > 0 }}
    # https://github.com/bahmutov/cypress-workflows
    uses: bahmutov/cypress-workflows/.github/workflows/split.yml@v2
    with:
      spec: ${{ needs.find-changed-specs.outputs.changedSpecs }}
